
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Spark computing environment &#8212; Distributed and Cluster Computing</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data parallel computing with Spark" href="15-data-parallel.html" />
    <link rel="prev" title="MapReduce Programming Paradigm" href="13-mapreduce.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Distributed and Cluster Computing</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Syllabus
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01-computational-demand.html">
   The demand for computational speed
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02-intro-to-parallel-distributed-computing.html">
   Introduction to paralel and distributed computing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-intro-to-c.html">
   Introduction to C
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04-intro-openmp.html">
   Introduction to OpenMP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05-loop-parallelism.html">
   OpenMP: parallel regions and loop parallelism
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06-works-sharing.html">
   OpenMP: Work sharing and controlling thread data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07-intro-mpi.html">
   Introduction to MPI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08-point-to-point.html">
   MPI: point-to-point, data types, and communicators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09-functional-collectives.html">
   MPI: Functional parallelism and collectives
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10-pleasantly-parallel.html">
   MPI: pleasantly parallel and workload allocation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11-divide-conquer.html">
   Partitioning: Divide and Conquer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12-data-intensive-computing.html">
   Introduction to Big Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13-mapreduce.html">
   MapReduce Programming Paradigm
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Spark computing environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15-data-parallel.html">
   Data parallel computing with Spark
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16-page-rank.html">
   Page Rank
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17-locality-sensitive-hashing.html">
   Locality Sensitive Hashing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="18-frequent-itemsets.html">
   Frequent Itemsets
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/episodes/14-spark.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-is-spark">
   1. What is Spark?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-philosophy">
   2. Design philosophy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-brief-history-of-spark">
   3. A brief history of Spark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spark-applications">
   4. Spark applications
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hands-on-word-count-in-spark">
   5. Hands-on: Word Count in Spark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-distribution-in-spark">
   6. Data distribution in Spark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transformation">
   7. Transformation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lazy-evaluation-and-actions">
   8. Lazy evaluation and actions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hands-on-word-count-workflow-breakdown">
   9. Hands on: Word Count workflow breakdown
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#challenge-1">
   Challenge 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#solution">
   Solution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#challenge-2">
   Challenge 2
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Solution
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Spark computing environment</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-is-spark">
   1. What is Spark?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-philosophy">
   2. Design philosophy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-brief-history-of-spark">
   3. A brief history of Spark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spark-applications">
   4. Spark applications
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hands-on-word-count-in-spark">
   5. Hands-on: Word Count in Spark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-distribution-in-spark">
   6. Data distribution in Spark
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transformation">
   7. Transformation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lazy-evaluation-and-actions">
   8. Lazy evaluation and actions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hands-on-word-count-workflow-breakdown">
   9. Hands on: Word Count workflow breakdown
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#challenge-1">
   Challenge 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#solution">
   Solution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#challenge-2">
   Challenge 2
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   Solution
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="spark-computing-environment">
<h1>Spark computing environment<a class="headerlink" href="#spark-computing-environment" title="Permalink to this headline">#</a></h1>
<section id="what-is-spark">
<h2>1. What is Spark?<a class="headerlink" href="#what-is-spark" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>A unified compute engine and a set of libraries for parallel
data processing on computer clusters.</p></li>
</ul>
<img src="../fig/03-spark/01.png" alt="Spark" style="height:400px">
</section>
<section id="design-philosophy">
<h2>2. Design philosophy<a class="headerlink" href="#design-philosophy" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Unified</span></code>: Spark supports a wide range of data analytic tasks over the same
computing engine and a consistent set of APIs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Computing</span> <span class="pre">engine</span></code>: Spark handles loading data from storage systems and
perform computation on the data (in memory) rather than on permanent storage.
To adhere to the data locality principle, Spark relies on APIs to provide a
transparent common interface with different storage systems for all applications.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Libraries</span></code>: Via its APIs, Spark supports a wide array of internal and
external libraries for complex data analytic tasks.</p></li>
</ul>
</section>
<section id="a-brief-history-of-spark">
<h2>3. A brief history of Spark<a class="headerlink" href="#a-brief-history-of-spark" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Research project at UC Berkeley AMP Lab in 2009 to address drawbacks of
Hadoop MapReduce.</p></li>
<li><p>Paper published in 2010: <a class="reference external" href="https://static.usenix.org/events/hotcloud10/tech/full_papers/Zaharia.pdf">Spark: Cluster Computing with Working Sets</a></p></li>
<li><p>Source code is contributed to Apache in 2013. The project had more than 100
contributors from more than 30 organizations outside UC Berkeley.</p></li>
<li><p>Version 1.0 was released in 2014.</p></li>
<li><p>Currently, Spark is being used extensively in academic and industry
(NASA, CERN, Uber, Netflix …).</p></li>
</ul>
</section>
<section id="spark-applications">
<h2>4. Spark applications<a class="headerlink" href="#spark-applications" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Typically consists of a <code class="docutils literal notranslate"><span class="pre">driver</span></code> process and a set of <code class="docutils literal notranslate"><span class="pre">executor</span></code> processes.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">driver</span></code> runs the main function and is responsible for:</p>
<ul>
<li><p>maintaining information about the Spark application,</p></li>
<li><p>responding to a user’s program or input, and</p></li>
<li><p>analyzing, distributing, and scheduling work across the executors.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">executors</span></code> carry out the actual work assigned to them by the <code class="docutils literal notranslate"><span class="pre">driver</span></code>.</p></li>
</ul>
<img src="../fig/03-spark/02.png" alt="Spark application architecture" style="height:400px">
<ul class="simple">
<li><p>Spark also has a local mode (what we are using for this class), where driver
and executors are simply processes on the same machine.</p></li>
<li><p>Spark application developed in local mode can be carried over almost <code class="docutils literal notranslate"><span class="pre">as-is</span></code>
to run in cluster mode (one of the attractiveness of Spark).</p></li>
<li><p>Spark supports the following language APIs: Scala, Java, Python, SQL (ANSI SQL 2003 standard), and R.</p></li>
</ul>
</section>
<section id="hands-on-word-count-in-spark">
<h2>5. Hands-on: Word Count in Spark<a class="headerlink" href="#hands-on-word-count-in-spark" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Open a terminal.</p></li>
<li><p>Activate the <code class="docutils literal notranslate"><span class="pre">pyspark</span></code> conda environment, then launch Jupyter notebook</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ conda activate pyspark
$ jupyter notebook
</pre></div>
</div>
<ul class="simple">
<li><p>Create a new notebook using the <code class="docutils literal notranslate"><span class="pre">pyspark</span></code> kernel, then change the notebook’s
name to <code class="docutils literal notranslate"><span class="pre">spark-1</span></code>.</p></li>
</ul>
<img src="../fig/03-spark/03.png" style="height:250px">
<ul class="simple">
<li><p>Enter the following Python code into the first cell of <code class="docutils literal notranslate"><span class="pre">spark-1</span></code>, then run
the cell.</p></li>
<li><p>This code sets up the paths to Spark’s libraries and executables.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">spark_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SPARK_HOME&#39;</span><span class="p">]</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spark_path</span> <span class="o">+</span> <span class="s2">&quot;/bin&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spark_path</span> <span class="o">+</span> <span class="s2">&quot;/python&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spark_path</span> <span class="o">+</span> <span class="s2">&quot;/python/pyspark/&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spark_path</span> <span class="o">+</span> <span class="s2">&quot;/python/lib&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spark_path</span> <span class="o">+</span> <span class="s2">&quot;/python/lib/pyspark.zip&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spark_path</span> <span class="o">+</span> <span class="s2">&quot;/python/lib/py4j-0.10.9-src.zip&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">findspark</span>
<span class="n">findspark</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="kn">import</span> <span class="nn">pyspark</span>
</pre></div>
</div>
<img src="../fig/03-spark/04.png" style="height:250px">
<ul class="simple">
<li><p>Enter the following Python code into the next cell, adjust <code class="docutils literal notranslate"><span class="pre">number_cores</span></code> and
<code class="docutils literal notranslate"><span class="pre">memory_gb</span></code> based on your computer’s hardware, then run the cell.</p>
<ul>
<li><p>This code sets up the configuration for the supporting Spark cluster (in
local mode).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">number_cores</span></code> should be one less than the total number of cores on your
computer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memory_gb</span></code> should be half the amount of memory that you have, or at least
3GB less.</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">number_cores</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">memory_gb</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">pyspark</span><span class="o">.</span><span class="n">SparkConf</span><span class="p">()</span><span class="o">.</span><span class="n">setMaster</span><span class="p">(</span><span class="s1">&#39;local[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_cores</span><span class="p">))</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;spark.driver.memory&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">g&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_gb</span><span class="p">)))</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">pyspark</span><span class="o">.</span><span class="n">SparkContext</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
</pre></div>
</div>
<img src="../fig/03-spark/05.png" style="height:250px">
<ul class="simple">
<li><p>At this point, if you visit <code class="docutils literal notranslate"><span class="pre">127.0.0.1:4040</span></code> in another browser tab,
you should also see the local Spark cluster up and running (with no job).</p></li>
</ul>
<img src="../fig/03-spark/06.png" style="height:250px">
<ul class="simple">
<li><p>Enter the following Python code into the third cell.</p></li>
<li><p>Pay attention to the strings inside <code class="docutils literal notranslate"><span class="pre">sc.textFile(&quot;A_STRING&quot;)</span></code> and <code class="docutils literal notranslate"><span class="pre">wordcount.saveAsTextFile(&quot;ANOTHER_STRING&quot;)</span></code>.</p>
<ul>
<li><p>These strings represent the path to where the original data is located
(<code class="docutils literal notranslate"><span class="pre">sc.textFile</span></code>) and where the output directory to be saved
(<code class="docutils literal notranslate"><span class="pre">wordcount.saveAsTextFile</span></code>).</p></li>
<li><p>Take your time here to organize the directories properly.</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">textFile</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="s2">&quot;../data/shakespeare/shakespeare-complete.txt&quot;</span><span class="p">)</span>
<span class="n">wordcount</span> <span class="o">=</span> <span class="n">textFile</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="n">wordcount</span><span class="o">.</span><span class="n">saveAsTextFile</span><span class="p">(</span><span class="s2">&quot;../data/output/output-wordcount-01&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>A successful run will generate the resulting output directory
that contain <code class="docutils literal notranslate"><span class="pre">_SUCCESS</span></code> flag file (size 0).</p></li>
</ul>
<img src="../fig/03-spark/07.png" style="height:250px">
</section>
<section id="data-distribution-in-spark">
<h2>6. Data distribution in Spark<a class="headerlink" href="#data-distribution-in-spark" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Data in spark are managed as <code class="docutils literal notranslate"><span class="pre">distributed</span> <span class="pre">collection</span></code>: when running on a
cluster, parts of the data are distributed across different machines and are
manipulated by different executors.</p></li>
<li><p>To allow executor to perform work in parallel breaks up data into chunks
called <code class="docutils literal notranslate"><span class="pre">partitions</span></code>.</p></li>
<li><p>Run the following code in a cell on <code class="docutils literal notranslate"><span class="pre">spark-1</span></code></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">textFile</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span>
</pre></div>
</div>
<img src="../fig/03-spark/08.png" style="height:200px">
</section>
<section id="transformation">
<h2>7. Transformation<a class="headerlink" href="#transformation" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>In Spark, the core data structures are <code class="docutils literal notranslate"><span class="pre">immutable</span></code>, meaning they cannot
be changed after creation.</p></li>
<li><p>To <code class="docutils literal notranslate"><span class="pre">change</span></code> a data collection means to <code class="docutils literal notranslate"><span class="pre">create</span></code> a new data collection that
is a <code class="docutils literal notranslate"><span class="pre">transformation</span></code> from the old one.</p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/rdd-programming-guide.html#transformations">List of common Spark’s transformations</a></p></li>
<li><p>There are two types of transformation:</p>
<ul>
<li><p>Narrow dependencies (1-to-1 transformation).</p></li>
<li><p>Wide dependencies (1-to-N transformation).
|                                   | MULTICS | UNIX       |<br />
| ——————————— | ——- | ———- |
| process abstraction               | yes     | yes        |<br />
| virtual memory                    | yes     | not really |<br />
| dynamic linking                   | yes     | not really |<br />
| hierarchical file system          | yes     | yes        |<br />
| programmed in high-level language | PL/1    | Assembly   |<br />
| multilevel security               | no      | later      |<br />
| online reconfiguration            | yes     | reboot     |<br />
| machine costs                     | M<span class="math notranslate nohighlight">\(      | K\)</span>         |</p></li>
</ul>
</li>
<li><p>We can make a copy of our <code class="docutils literal notranslate"><span class="pre">textFile</span></code> that is distributed across more
partitions. This is still a <code class="docutils literal notranslate"><span class="pre">narrow</span> <span class="pre">dependencies</span></code> transformation.</p></li>
<li><p>Run the following code in a cell on <code class="docutils literal notranslate"><span class="pre">spark-1</span></code></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">textFile_4</span> <span class="o">=</span> <span class="n">textFile</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">textFile_4</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span>
</pre></div>
</div>
<img src="../fig/03-spark/09.png" style="height:100px">
<ul class="simple">
<li><p>Run the following code in a cell on <code class="docutils literal notranslate"><span class="pre">spark-1</span></code></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wordcount</span> <span class="o">=</span> <span class="n">textFile_4</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="n">wordcount</span><span class="o">.</span><span class="n">saveAsTextFile</span><span class="p">(</span><span class="s2">&quot;../data/output/output-wordcount-02&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../fig/03-spark/10.png" style="height:200px">
<ul class="simple">
<li><p>There are now four resulting output files:</p></li>
</ul>
<img src="../fig/03-spark/11.png" style="height:300px">
</section>
<section id="lazy-evaluation-and-actions">
<h2>8. Lazy evaluation and actions<a class="headerlink" href="#lazy-evaluation-and-actions" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Transformations</span></code>are logical plan only.</p></li>
<li><p>Spark will wait until the very last moment to execute the graph of
computation instructions (the logical plan).</p></li>
<li><p>To trigger the computation, we run an <code class="docutils literal notranslate"><span class="pre">action</span></code>.</p></li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/rdd-programming-guide.html#actions">List of common Spark actions</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wordcount</span> <span class="o">=</span> <span class="n">textFile_4</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wordcount</span><span class="p">)</span>
</pre></div>
</div>
<img src="../fig/03-spark/12.png" style="height:150px">
<ul class="simple">
<li><p>There are three kind of actions:</p>
<ul>
<li><p>Actions to view data in the console (e.g., <code class="docutils literal notranslate"><span class="pre">take</span></code>).</p></li>
<li><p>Action to collect data to native objects (e.g., <code class="docutils literal notranslate"><span class="pre">collect</span></code>).</p></li>
<li><p>Action to write to output data sources (e.g., <code class="docutils literal notranslate"><span class="pre">saveAsTextFile</span></code>).</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wordcount</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local_words</span> <span class="o">=</span> <span class="n">wordcount</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">local_words</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
<img src="../fig/03-spark/13.png" style="height:500px">
</section>
<section id="hands-on-word-count-workflow-breakdown">
<h2>9. Hands on: Word Count workflow breakdown<a class="headerlink" href="#hands-on-word-count-workflow-breakdown" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Run each of the following segments of Python code in a separate cell.</p></li>
<li><p>RDD of text file has a single item per row of collection.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">textFile_4</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">flatMap</span></code> breaks lines into lists of words, and concatenate these lists
into a single new RDD.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wordcount_1</span> <span class="o">=</span> <span class="n">textFile_4</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
<span class="n">wordcount_1</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Each item in this new RDD is turned into a (key/value) pair, with
key is a word, and value is `.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wordcount_2</span> <span class="o">=</span> <span class="n">wordcount_1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">wordcount_2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>All pairs with the same key are <code class="docutils literal notranslate"><span class="pre">reduced</span></code> together using pairwise
summation to get the final count of each key.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wordcount_3</span> <span class="o">=</span> <span class="n">wordcount_2</span><span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="n">wordcount_3</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img src="../fig/03-spark/14.png" style="height:800px">
</section>
<section id="challenge-1">
<h2>Challenge 1<a class="headerlink" href="#challenge-1" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Augment the mapping process of WordCount with a function to filter out
punctuations and capitalization from the unique words</p></li>
<li><p>Hint: The string module is helpful for removing punctuation.</p></li>
</ul>
</section>
<section id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
<span class="n">translator</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
<span class="n">wordcount_enhanced</span> <span class="o">=</span> <span class="n">textFile</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> \
           <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translator</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">1</span><span class="p">))</span> \
           <span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
<span class="n">wordcount_enhanced</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>{: .solution}
{: .challenge}</p>
</section>
<section id="challenge-2">
<h2>Challenge 2<a class="headerlink" href="#challenge-2" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Look up the <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/pyspark.html?highlight=filter#pyspark.RDD.filter">Spark Python API for filter</a>.</p></li>
<li><p>Augment the results from Challenge 1 to remove the empty spaces (<code class="docutils literal notranslate"><span class="pre">''</span></code>).</p></li>
</ul>
</section>
<section id="id1">
<h2>Solution<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wordcount_filtered</span> <span class="o">=</span> <span class="n">wordcount_enhanced</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">wordcount_filtered</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>{: .solution}
{: .challenge}</p>
<p>{% include <a class="reference external" href="http://links.md">links.md</a> %}</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./episodes"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="13-mapreduce.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">MapReduce Programming Paradigm</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="15-data-parallel.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Data parallel computing with Spark</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Linh Ngo<br/>
  
    <div class="extra_footer">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"></a> <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Computer Systems</span> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.
    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>